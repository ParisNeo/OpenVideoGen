<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenVideoGen - Video Generation UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Arabic:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a, #9333ea, #4f46e5);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #e5e7eb;
        }
        [lang="ar"] body {
            font-family: 'Noto Sans Arabic', sans-serif;
            direction: rtl;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
        }
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            transition: all 0.3s ease;
        }
        .top-bar:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        #settingsModal {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        #settingsModal.show {
            display: flex;
            opacity: 1;
        }
        #settingsModal .glass {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #settingsModal.show .glass {
            transform: scale(1);
        }
        button, select, input, textarea {
            transition: all 0.2s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        select:hover, input:hover, textarea:hover {
            border-color: #a855f7;
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        #progressBar {
            transition: width 0.5s ease;
        }
        .settings-btn svg {
            transition: transform 0.2s ease;
        }
        .settings-btn:hover svg {
            transform: rotate(90deg);
        }
        /* Scrollbar styling for prompt history */
        #promptHistory {
             /* Optional: Style scrollbar if needed */
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar glass p-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <img src="/static/assets/openvideogen-icon.png" alt="OpenVideoGen Icon" class="w-8 h-8">
            <h1 class="text-xl font-bold tracking-tight">OpenVideoGen</h1>
        </div>
        <div class="flex items-center space-x-4">
            <select id="language" class="bg-gray-900 text-white p-2 rounded-lg border border-gray-800 hover:bg-gray-800">
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="ar">العربية</option>
            </select>
            <a href="https://github.com/ParisNeo/OpenVideoGen" target="_blank" aria-label="GitHub Stars">
                <img src="https://img.shields.io/github/stars/ParisNeo/OpenVideoGen.svg?style=social&label=Stars" alt="GitHub Stars" class="h-5">
            </a>
            <button id="settingsBtn" class="settings-btn bg-purple-700 hover:bg-purple-800 text-white p-2 rounded-lg" aria-label="Open Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- SVG Icon -->
                    <path d="M19.14,12.94a2,2,0,0,0-.14-.68l1.78-1a1,1,0,0,0,.36-1.16l-2-3.46a1,1,0,0,0-1.14-.46l-2.07.83a7.25,7.25,0,0,0-1.2-.55l-.32-2.25a1,1,0,0,0-1-.94H9.56a1,1,0,0,0-1,.94l-.32,2.25a7.25,7.25,0,0,0-1.2.55L5,6.49a1,1,0,0,0-1.14.46l-2,3.46a1,1,0,0,0,.36,1.16l1.78,1a2,2,0,0,0-.14.68,2,2,0,0,0,.14.68l-1.78,1a1,1,0,0,0-.36,1.16l2,3.46a1,1,0,0,0,1.14.46l2.07-.83a7.25,7.25,0,0,0,1.2.55l.32,2.25a1,1,0,0,0,1,.94h4.88a1,1,0,0,0,1-.94l.32-2.25a7.25,7.25,0,0,0,1.2-.55l2.07.83a1,1,0,0,0,1.14-.46l2-3.46a1,1,0,0,0-.36-1.16ZM12,15a3,3,0,1,1,3-3A3,3,0,0,1,12,15Z" fill="#fff"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-20" aria-modal="true" role="dialog">
        <div class="glass p-6 w-full max-w-md">
            <h2 class="text-2xl font-semibold mb-6" data-i18n="settings">Settings</h2>
            <div class="space-y-6">
                <div>
                    <label for="negative_prompt" class="block text-sm font-medium" data-i18n="negative_prompt">Negative Prompt</label>
                    <textarea id="negative_prompt" name="negative_prompt" rows="2" class="mt-1 w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500" data-i18n-placeholder="negative_prompt_placeholder"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="guidance_scale" class="block text-sm font-medium" data-i18n="guidance_scale">Guidance Scale</label>
                        <input type="number" id="guidance_scale" name="guidance_scale" min="1" max="20" step="0.1" value="6.0" class="mt-1 w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="steps" class="block text-sm font-medium" data-i18n="steps">Inference Steps</label>
                        <input type="number" id="steps" name="steps" min="1" value="50" class="mt-1 w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="seed" class="block text-sm font-medium" data-i18n="seed">Seed</label>
                        <input type="number" id="seed" name="seed" min="-1" value="-1" class="mt-1 w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="fps" class="block text-sm font-medium" data-i18n="fps">FPS</label>
                        <input type="number" id="fps" name="fps" min="1" value="8" class="mt-1 w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="md:col-span-2"> <!-- Make resolution span full width on medium screens -->
                        <label for="resolution" class="block text-sm font-medium" data-i18n="resolution">Resolution</label>
                        <select id="resolution" class="mt-1 w-full p-3 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <!-- Options populated dynamically or kept static -->
                            <option value="480x360">480x360 (360p)</option>
                            <option value="720x480">720x480 (480p Wide)</option>
                            <option value="832x480">832x480 (Wan 480p)</option>
                            <option value="848x480">848x480 (480p)</option>
                            <option value="1280x720" selected>1280x720 (720p)</option>
                            <option value="1920x1080">1920x1080 (1080p)</option>
                            <option value="2560x1440">2560x1440 (1440p)</option>
                            <option value="3840x2160">3840x2160 (4K)</option>
                        </select>
                        <!-- Hidden inputs to store parsed width/height -->
                        <input type="hidden" id="height" name="height" value="720">
                        <input type="hidden" id="width" name="width" value="1280">
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeSettings" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg" data-i18n="close">Close</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 pt-20 pb-12 max-w-5xl"> <!-- Added pt-20 for top bar clearance -->
        <!-- Header -->
        <header class="text-center mb-12">
            <p class="text-xl text-gray-200 font-medium" data-i18n="tagline">Generate stunning videos with AI-powered diffusion models</p>
            <p class="mt-2 text-sm text-gray-400">Created by <a href="https://github.com/ParisNeo" target="_blank" class="text-purple-400 hover:underline">ParisNeo</a></p>
        </header>

        <!-- Tabs -->
        <div class="glass p-6">
            <div class="flex border-b border-gray-700">
                <button id="tab-generate" class="tab-btn flex-1 py-3 px-4 text-center font-semibold text-purple-400 border-b-2 border-purple-600" data-i18n="tab_generate">Generate Video</button>
                <button id="tab-status" class="tab-btn flex-1 py-3 px-4 text-center font-semibold text-gray-300" data-i18n="tab_status">Job Status</button>
                <button id="tab-help" class="tab-btn flex-1 py-3 px-4 text-center font-semibold text-gray-300" data-i18n="tab_help">Help</button>
            </div>

            <!-- Generate Video Tab -->
            <div id="content-generate" class="tab-content mt-6">
                <form id="videoForm" class="space-y-6">
                    <div>
                        <label for="prompt" class="block text-sm font-medium" data-i18n="prompt">Prompt</label>
                        <textarea id="prompt" name="prompt" rows="3" class="mt-1 w-full p-4 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500" data-i18n-placeholder="prompt_placeholder"></textarea>
                    </div>
                    <div>
                        <label for="promptHistory" class="block text-sm font-medium" data-i18n="prompt_history">Prompt History</label>
                        <select id="promptHistory" class="mt-1 w-full p-4 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="" data-i18n="select_prompt_history">Select a previous prompt</option>
                            <!-- History options populated by JS -->
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="model" class="block text-sm font-medium" data-i18n="model">Model</label>
                            <select id="model" name="model_name" class="mt-1 w-full p-4 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="" data-i18n="loading_models">Loading models...</option>
                                <!-- Model options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="frames" class="block text-sm font-medium" data-i18n="frames">Number of Frames</label>
                            <input type="number" id="frames" name="nb_frames" min="1" value="49" class="mt-1 w-full p-4 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-lg" data-i18n="generate">Generate Video</button>
                    </div>
                </form>
                <p id="formMessage" class="mt-4 text-sm text-gray-300 hidden"></p>
            </div>

            <!-- Job Status Tab -->
            <div id="content-status" class="tab-content mt-6 hidden">
                <div class="space-y-6">
                    <div class="flex space-x-4">
                        <input type="text" id="jobIdInput" class="flex-1 p-4 rounded-lg bg-gray-900 text-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500" data-i18n-placeholder="job_id_placeholder">
                        <button id="checkStatusBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg" data-i18n="check_status">Check Status</button>
                    </div>
                    <div id="statusDisplay" class="text-sm text-gray-300 hidden">
                        <p><strong data-i18n="job_id">Job ID:</strong> <span id="jobId"></span></p>
                        <p><strong data-i18n="status">Status:</strong> <span id="status"></span></p>
                        <p><strong data-i18n="progress">Progress:</strong> <span id="progressValue">0%</span></p>
                        <div class="w-full bg-gray-800 rounded-full h-3 mt-2">
                            <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-indigo-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="mt-2"><strong data-i18n="message">Message:</strong> <span id="message"></span></p>
                        <div id="downloadSection" class="mt-4 hidden">
                            <a id="downloadLink" href="#" class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mr-4" data-i18n="download" download>Download Video</a>
                            <button id="previewBtn" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg" data-i18n="preview">Preview Video</button>
                            <video id="videoPreview" controls class="mt-4 w-full rounded-lg shadow-lg hidden" preload="metadata">
                                <source id="videoSource" type="video/mp4">
                            </video>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div id="content-help" class="tab-content mt-6 hidden">
                <div class="space-y-4 text-sm text-gray-300">
                    <p><strong data-i18n="how_to_use">How to Use:</strong></p>
                    <ul class="list-disc list-inside space-y-1" data-i18n="how_to_use_list">
                        <!-- Content filled by JS -->
                    </ul>
                    <p><strong data-i18n="tips">Tips:</strong></p>
                    <ul class="list-disc list-inside space-y-1" data-i18n="tips_list">
                         <!-- Content filled by JS -->
                    </ul>
                     <p class="mt-4"><strong data-i18n="api_docs_link">API Documentation:</strong> <a href="/docs" target="_blank" class="text-purple-400 hover:underline">/docs</a></p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-400 text-sm mt-12">
            <p>© 2025 OpenVideoGen by <a href="https://github.com/ParisNeo" target="_blank" class="text-purple-400 hover:underline">ParisNeo</a> | <a href="https://github.com/ParisNeo/OpenVideoGen" target="_blank" class="text-purple-400 hover:underline">GitHub</a> | <a href="https://github.com/ParisNeo/lollms-webui" target="_blank" class="text-purple-400 hover:underline">LoLLMs WebUI</a></p>
        </footer>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = window.location.origin;
        const PROMPT_HISTORY_LIMIT = 15;
        const POLLING_INTERVAL_MS = 2500; // Check status every 2.5 seconds

        // --- State ---
        let pollingInterval = null;
        const settingFields = ['language', 'negative_prompt', 'guidance_scale', 'steps', 'seed', 'fps', 'resolution', 'model', 'frames']; // Include model & frames now

        // --- DOM Elements (Cache frequently used elements) ---
        const domElements = {
            languageSelect: document.getElementById('language'),
            settingsModal: document.getElementById('settingsModal'),
            settingsBtn: document.getElementById('settingsBtn'),
            closeSettingsBtn: document.getElementById('closeSettings'),
            tabs: document.querySelectorAll('.tab-btn'),
            contents: document.querySelectorAll('.tab-content'),
            videoForm: document.getElementById('videoForm'),
            promptInput: document.getElementById('prompt'),
            promptHistorySelect: document.getElementById('promptHistory'),
            modelSelect: document.getElementById('model'),
            framesInput: document.getElementById('frames'),
            resolutionSelect: document.getElementById('resolution'),
            widthInput: document.getElementById('width'),
            heightInput: document.getElementById('height'),
            formMessage: document.getElementById('formMessage'),
            jobIdInput: document.getElementById('jobIdInput'),
            checkStatusBtn: document.getElementById('checkStatusBtn'),
            statusDisplay: document.getElementById('statusDisplay'),
            jobIdSpan: document.getElementById('jobId'),
            statusSpan: document.getElementById('status'),
            progressValueSpan: document.getElementById('progressValue'),
            progressBar: document.getElementById('progressBar'),
            messageSpan: document.getElementById('message'),
            downloadSection: document.getElementById('downloadSection'),
            downloadLink: document.getElementById('downloadLink'),
            previewBtn: document.getElementById('previewBtn'),
            videoPreview: document.getElementById('videoPreview'),
            videoSource: document.getElementById('videoSource')
        };

        // --- Localization Data ---
        const translations = {
            // ... (Keep your existing translations object) ...
            en: {
                settings: "Settings", close: "Close", tagline: "Generate stunning videos with AI-powered diffusion models",
                tab_generate: "Generate Video", tab_status: "Job Status", tab_help: "Help",
                prompt: "Prompt", prompt_placeholder: "e.g., A futuristic cityscape at sunset, hyperrealistic, 4k",
                prompt_history: "Prompt History", select_prompt_history: "Select a previous prompt",
                negative_prompt: "Negative Prompt", negative_prompt_placeholder: "e.g., blurry, low quality, text, watermark",
                model: "Model", loading_models: "Loading models...", select_model: "Select a model",
                frames: "Number of Frames", guidance_scale: "Guidance Scale", steps: "Inference Steps",
                seed: "Seed", fps: "FPS", resolution: "Resolution",
                generate: "Generate Video", check_status: "Check Status", job_id_placeholder: "Enter Job ID",
                job_id: "Job ID:", status: "Status:", progress: "Progress:", message: "Message:",
                download: "Download", preview: "Preview",
                how_to_use: "How to Use:",
                how_to_use_list: `<li>Enter a detailed description (prompt) for your video.</li>
                                  <li>Select a generation model (check model info for strengths).</li>
                                  <li>Use the settings (⚙️ icon top-right) to adjust negative prompts, steps, FPS, resolution, etc. Settings are saved automatically.</li>
                                  <li>Click "Generate Video". Your Job ID will appear.</li>
                                  <li>Switch to the "Job Status" tab to track progress.</li>
                                  <li>Download or preview the video when completed.</li>`,
                tips: "Tips:",
                tips_list: `<li>Use the prompt history dropdown to quickly reuse past prompts.</li>
                            <li>Experiment with different models and settings. Higher steps usually mean better quality but longer generation.</li>
                            <li>A good negative prompt helps avoid unwanted elements.</li>
                            <li>For API usage, check the documentation link below.</li>`,
                api_docs_link: "API Documentation:"
            },
            fr: { // Example - Add full translations
                settings: "Paramètres", close: "Fermer", tagline: "Générez des vidéos époustouflantes avec des modèles de diffusion IA",
                tab_generate: "Générer Vidéo", tab_status: "Statut Tâche", tab_help: "Aide",
                prompt: "Invite", prompt_placeholder: "ex., Paysage urbain futuriste au coucher du soleil, hyperréaliste, 4k",
                prompt_history: "Historique", select_prompt_history: "Choisir une invite précédente",
                negative_prompt: "Invite Négative", negative_prompt_placeholder: "ex., flou, basse qualité, texte",
                model: "Modèle", loading_models: "Chargement...", select_model: "Choisir un modèle",
                frames: "Nb Images", guidance_scale: "Échelle Guidage", steps: "Étapes Inférence",
                seed: "Graine", fps: "IPS", resolution: "Résolution",
                generate: "Générer Vidéo", check_status: "Vérifier Statut", job_id_placeholder: "Entrez l'ID",
                job_id: "ID Tâche:", status: "Statut:", progress: "Progrès:", message: "Message:",
                download: "Télécharger", preview: "Aperçu",
                how_to_use: "Comment utiliser :",
                how_to_use_list: `<li>Entrez une description (invite) détaillée.</li>
                                  <li>Sélectionnez un modèle.</li>
                                  <li>Utilisez les paramètres (⚙️) pour ajuster. Ils sont sauvegardés.</li>
                                  <li>Cliquez sur "Générer Vidéo".</li>
                                  <li>Suivez la progression dans l'onglet "Statut Tâche".</li>
                                  <li>Téléchargez ou prévisualisez quand c'est prêt.</li>`,
                tips: "Conseils :",
                tips_list: `<li>Utilisez l'historique des invites.</li>
                            <li>Expérimentez avec les modèles et paramètres.</li>
                            <li>Une bonne invite négative améliore le résultat.</li>
                            <li>Pour l'API, voir la documentation ci-dessous.</li>`,
                api_docs_link: "Documentation API :"
            },
             ar: { // Example - Add full translations
                settings: "الإعدادات", close: "إغلاق", tagline: "أنشئ فيديوهات مذهلة بنماذج الانتشار بالذكاء الاصطناعي",
                tab_generate: "إنشاء فيديو", tab_status: "حالة المهمة", tab_help: "مساعدة",
                prompt: "الموجه", prompt_placeholder: "مثال: مدينة مستقبلية عند الغروب، واقعية فائقة، 4k",
                prompt_history: "سجل الموجهات", select_prompt_history: "اختر موجهًا سابقًا",
                negative_prompt: "الموجه السلبي", negative_prompt_placeholder: "مثال: ضبابي، جودة منخفضة، نص",
                model: "النموذج", loading_models: "جاري التحميل...", select_model: "اختر نموذجًا",
                frames: "عدد الإطارات", guidance_scale: "مقياس التوجيه", steps: "خطوات الاستدلال",
                seed: "البذرة", fps: "إطار/ث", resolution: "الدقة",
                generate: "إنشاء فيديو", check_status: "تحقق من الحالة", job_id_placeholder: "أدخل معرف المهمة",
                job_id: "معرف المهمة:", status: "الحالة:", progress: "التقدم:", message: "الرسالة:",
                download: "تنزيل", preview: "معاينة",
                how_to_use: "كيفية الاستخدام:",
                how_to_use_list: `<li>أدخل وصفًا تفصيليًا (موجهًا).</li>
                                  <li>اختر نموذج التوليد.</li>
                                  <li>استخدم الإعدادات (⚙️) للتعديل. يتم حفظها تلقائيًا.</li>
                                  <li>انقر "إنشاء فيديو".</li>
                                  <li>تابع التقدم في تبويب "حالة المهمة".</li>
                                  <li>قم بالتنزيل أو المعاينة عند الانتهاء.</li>`,
                tips: "نصائح:",
                tips_list: `<li>استخدم سجل الموجهات لإعادة الاستخدام.</li>
                            <li>جرب نماذج وإعدادات مختلفة.</li>
                            <li>الموجه السلبي الجيد يحسن النتائج.</li>
                            <li>لاستخدام الواجهة البرمجية، انظر رابط التوثيق أدناه.</li>`,
                api_docs_link: "توثيق الواجهة البرمجية:"
            }
        };


        // --- Core Functions ---

        // Populate model dropdown
        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE_URL}/models`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                domElements.modelSelect.innerHTML = ''; // Clear loading/existing options

                // Add a default "Select" option
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = translations[domElements.languageSelect.value]?.select_model || "Select a model";
                defaultOption.disabled = true; // Make it unselectable unless it's the only option
                domElements.modelSelect.appendChild(defaultOption);

                if (data.models && data.models.length > 0) {
                    defaultOption.disabled = false; // Allow selection if other models exist
                    data.models.forEach(modelInfo => {
                        const option = document.createElement('option');
                        option.value = modelInfo.id; // Use the model key/id
                        option.textContent = `${modelInfo.id} (${modelInfo.type || 'N/A'}) ${modelInfo.loaded ? '' : '(Not Loaded)'}`;
                        option.disabled = !modelInfo.loaded; // Disable if not loaded
                        if (!modelInfo.loaded) {
                           option.style.color = '#9ca3af'; // Gray out unloaded models
                        }
                        domElements.modelSelect.appendChild(option);
                    });
                     // After loading models, try to restore the saved selection
                    const savedModel = localStorage.getItem('settings_model');
                    if (savedModel && domElements.modelSelect.querySelector(`option[value="${savedModel}"]`)) {
                        domElements.modelSelect.value = savedModel;
                    } else if (domElements.modelSelect.options.length > 1) {
                        // Select the first *loaded* model if no saved one is found or valid
                        let firstLoaded = Array.from(domElements.modelSelect.options).find(opt => opt.value && !opt.disabled);
                         if(firstLoaded) domElements.modelSelect.value = firstLoaded.value;
                         else domElements.modelSelect.value = ""; // Fallback to default "Select" if none loaded
                    } else {
                         domElements.modelSelect.value = ""; // Fallback if only default exists
                    }

                } else {
                    defaultOption.textContent = "No models found";
                    domElements.modelSelect.disabled = true;
                }


            } catch (error) {
                console.error('Failed to load models:', error);
                domElements.modelSelect.innerHTML = '<option value="">Error loading models</option>';
                 domElements.modelSelect.disabled = true;
            }
        }

        // Localization function
        function updateLanguage(lang) {
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translation = translations[lang]?.[key];
                if (translation) {
                    // Handle specific elements like lists separately if needed
                     if (el.tagName === 'UL') {
                        el.innerHTML = translation; // Assumes translation includes <li> tags
                    } else {
                        el.textContent = translation;
                    }
                } else {
                    // Fallback or keep original text if translation missing
                    // console.warn(`Missing translation for key: ${key} in lang: ${lang}`);
                }
            });
            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                 el.placeholder = translations[lang]?.[key] || '';
            });

             // Update dynamic button texts (already done for some, ensure all are covered)
            domElements.videoForm.querySelector('button[type="submit"]').textContent = translations[lang]?.generate || 'Generate Video';
            domElements.closeSettingsBtn.textContent = translations[lang]?.close || 'Close';
            domElements.checkStatusBtn.textContent = translations[lang]?.check_status || 'Check Status';
            domElements.downloadLink.textContent = translations[lang]?.download || 'Download';
            domElements.previewBtn.textContent = translations[lang]?.preview || 'Preview';
        }

        // --- Persistence Functions ---

        function loadSettings() {
            // Language first
            const lang = localStorage.getItem('language') || 'en';
            domElements.languageSelect.value = lang;
            updateLanguage(lang); // Apply loaded language

            // Load other settings
            settingFields.forEach(fieldId => {
                // Skip language as it's handled above
                if (fieldId === 'language') return;

                const value = localStorage.getItem(`settings_${fieldId}`);
                const element = document.getElementById(fieldId); // Get element inside loop

                if (element && value !== null) {
                    try {
                        if (fieldId === 'resolution') {
                            element.value = value;
                            updateResolution(value); // Update hidden inputs
                        } else {
                            element.value = value;
                        }
                    } catch (e) {
                        console.error(`Error applying saved setting for ${fieldId}:`, e);
                    }
                }
            });

            // Load last job ID
            const jobId = localStorage.getItem('lastJobId');
            if (jobId) {
                domElements.jobIdInput.value = jobId;
                checkJobStatus(jobId); // Attempt to check status on load
            }

            // Load prompt history
            loadPromptHistory();
        }

        function saveSettings() {
            // Save language
            localStorage.setItem('language', domElements.languageSelect.value);

            // Save other fields
            settingFields.forEach(fieldId => {
                 if (fieldId === 'language') return; // Skip language

                const element = document.getElementById(fieldId);
                if (element) {
                    localStorage.setItem(`settings_${fieldId}`, element.value);
                     // Special handling for resolution to update hidden fields when saved via modal
                     if (fieldId === 'resolution') {
                         updateResolution(element.value);
                     }
                }
            });
             console.log("Settings saved to localStorage");
        }

        // Prompt history management
        function savePrompt(prompt) {
            if (!prompt || !prompt.trim()) return; // Don't save empty prompts

            let prompts = [];
            try {
                prompts = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            } catch (e) {
                console.error("Error parsing prompt history:", e);
                prompts = []; // Reset if invalid JSON
            }

            // Remove existing instance of the prompt to move it to the top
            prompts = prompts.filter(p => p !== prompt);

            // Add to the beginning
            prompts.unshift(prompt);

            // Limit history size
            if (prompts.length > PROMPT_HISTORY_LIMIT) {
                prompts = prompts.slice(0, PROMPT_HISTORY_LIMIT);
            }

            try {
                localStorage.setItem('promptHistory', JSON.stringify(prompts));
            } catch (e) {
                 console.error("Error saving prompt history:", e);
            }
            loadPromptHistory(); // Update dropdown immediately
        }

        function loadPromptHistory() {
            let prompts = [];
             try {
                prompts = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            } catch (e) {
                 console.error("Error parsing prompt history on load:", e);
                prompts = [];
            }

            const select = domElements.promptHistorySelect;
            // Keep the first "Select..." option, clear the rest
            select.length = 1;
            select.options[0].textContent = translations[domElements.languageSelect.value]?.select_prompt_history || "Select a previous prompt";


            prompts.forEach(prompt => {
                const option = document.createElement('option');
                option.value = prompt;
                // Truncate long prompts for display in the dropdown
                option.textContent = prompt.length > 80 ? prompt.substring(0, 77) + '...' : prompt;
                select.appendChild(option);
            });
             select.selectedIndex = 0; // Ensure "Select..." is shown initially
        }

        // --- UI Interaction Functions ---

        // Update hidden height/width based on resolution dropdown
        function updateResolution(value) {
            if (value && value.includes('x')) {
                const [width, height] = value.split('x');
                domElements.widthInput.value = width;
                domElements.heightInput.value = height;
            } else {
                 // Handle cases where value might be empty or invalid
                 console.warn("Invalid resolution value:", value);
                 domElements.widthInput.value = ''; // Or set a default
                 domElements.heightInput.value = ''; // Or set a default
            }
        }

        function showFormMessage(text, isError = false) {
            domElements.formMessage.textContent = text;
            domElements.formMessage.classList.remove('hidden');
            if (isError) {
                domElements.formMessage.classList.remove('text-green-400');
                domElements.formMessage.classList.add('text-red-400');
            } else {
                domElements.formMessage.classList.remove('text-red-400');
                domElements.formMessage.classList.add('text-green-400');
            }
            // Optional: Hide message after some time
             setTimeout(() => { domElements.formMessage.classList.add('hidden'); }, 5000);
        }

        function resetStatusDisplay() {
             domElements.statusDisplay.classList.add('hidden');
             domElements.jobIdSpan.textContent = '';
             domElements.statusSpan.textContent = '';
             domElements.progressValueSpan.textContent = '0%';
             domElements.progressBar.style.width = '0%';
             domElements.messageSpan.textContent = '';
             domElements.downloadSection.classList.add('hidden');
             domElements.videoPreview.classList.add('hidden');
             domElements.videoPreview.pause();
             domElements.videoSource.removeAttribute('src');
        }


        // --- Event Listeners ---

        // Load initial content on page load
        window.addEventListener('load', async () => {
            await loadModels(); // Load models first
            loadSettings(); // Then load settings (which might set the selected model)
            // Ensure resolution hidden fields are set based on initial/loaded value
            if (domElements.resolutionSelect.value) {
                 updateResolution(domElements.resolutionSelect.value);
            }
        });

        // Handle language change
        domElements.languageSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
            saveSettings(); // Save language preference immediately
            loadPromptHistory(); // Update prompt history dropdown text
        });

        // Handle settings changes and save them
        settingFields.forEach(id => {
            const element = document.getElementById(id);
            if (element && id !== 'language') { // Language handled separately
                element.addEventListener('change', saveSettings);
            }
        });

         // Update hidden resolution fields when dropdown changes
        domElements.resolutionSelect.addEventListener('change', (e) => {
            updateResolution(e.target.value);
             // saveSettings(); // Already saved by the generic handler above
        });

        // Handle prompt history selection
        domElements.promptHistorySelect.addEventListener('change', (e) => {
            if (e.target.value) {
                domElements.promptInput.value = e.target.value;
            }
        });

        // Settings modal toggle
        domElements.settingsBtn.addEventListener('click', () => {
            domElements.settingsModal.classList.add('show');
        });
        domElements.closeSettingsBtn.addEventListener('click', () => {
            domElements.settingsModal.classList.remove('show');
        });
        // Close modal on outside click
        domElements.settingsModal.addEventListener('click', (e) => {
            if (e.target === domElements.settingsModal) {
                domElements.settingsModal.classList.remove('show');
            }
        });

        // Tab switching logic
        domElements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Clear any previous polling
                 if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
                resetStatusDisplay(); // Reset status when switching tabs

                domElements.tabs.forEach(t => {
                    t.classList.remove('text-purple-400', 'border-b-2', 'border-purple-600');
                    t.classList.add('text-gray-300');
                });
                tab.classList.add('text-purple-400', 'border-b-2', 'border-purple-600');

                domElements.contents.forEach(c => c.classList.add('hidden'));
                const contentId = `content-${tab.id.split('-')[1]}`;
                const contentElement = document.getElementById(contentId);
                 if (contentElement) {
                     contentElement.classList.remove('hidden');
                 }

                 // If switching to status tab, maybe auto-check if ID field has value
                 if(tab.id === 'tab-status' && domElements.jobIdInput.value){
                     checkJobStatus(domElements.jobIdInput.value);
                 }
            });
        });

        // Handle form submission
        domElements.videoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPrompt = domElements.promptInput.value;
            if (!currentPrompt.trim()) {
                 showFormMessage("Prompt cannot be empty.", true);
                 return;
            }
            if (!domElements.modelSelect.value) {
                 showFormMessage("Please select a model.", true);
                 return;
            }


            savePrompt(currentPrompt); // Save prompt to history

            const formData = new FormData(domElements.videoForm); // Get data from form elements
             // Add settings from the modal that aren't direct form fields
             const settingsToAdd = ['negative_prompt', 'guidance_scale', 'steps', 'seed', 'fps', 'height', 'width'];
             settingsToAdd.forEach(fieldId => {
                 const element = document.getElementById(fieldId);
                 if (element && !formData.has(fieldId)) { // Add if not already present from form
                     formData.append(fieldId, element.value);
                 }
             });


             // Convert FormData to JSON object for the API
             const requestData = {};
             formData.forEach((value, key) => {
                // Convert numbers where appropriate
                const numFields = ['nb_frames', 'guidance_scale', 'steps', 'seed', 'fps', 'height', 'width'];
                if (numFields.includes(key) && value !== '') {
                    requestData[key] = Number(value);
                } else if (value !== '' || key === 'negative_prompt') { // Allow empty negative prompt, skip others
                     requestData[key] = value;
                 }
             });

             // Clear previous message
             domElements.formMessage.classList.add('hidden');

            try {
                const submitButton = domElements.videoForm.querySelector('button[type="submit"]');
                 submitButton.disabled = true;
                 submitButton.textContent = "Submitting...";


                const response = await fetch(`${API_BASE_URL}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                 submitButton.disabled = false;
                 submitButton.textContent = translations[domElements.languageSelect.value]?.generate || 'Generate Video';


                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown server error' }));
                     throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                 }

                const data = await response.json();
                showFormMessage(`Job submitted! Job ID: ${data.job_id}`);

                // --- Post-submission actions ---
                // 1. Save Job ID
                localStorage.setItem('lastJobId', data.job_id);

                // 2. Clear the prompt field ONLY
                domElements.promptInput.value = '';
                // 3. Reset prompt history selection
                domElements.promptHistorySelect.selectedIndex = 0;

                // 4. Switch to status tab
                document.getElementById('tab-status').click(); // Simulate click to switch

                // 5. Populate job ID input on status tab
                domElements.jobIdInput.value = data.job_id;

                // 6. Start checking status immediately
                checkJobStatus(data.job_id);

            } catch (error) {
                 console.error('Job submission failed:', error);
                 showFormMessage(`Failed to submit job: ${error.message || 'Network error'}`, true);
            }
        });


        // --- Job Status Functions ---

        async function checkJobStatus(jobId) {
            if (!jobId || !jobId.trim()) {
                resetStatusDisplay();
                return;
            }
            console.log(`Checking status for job: ${jobId}`);

            // Clear any existing interval before starting a new one
             if (pollingInterval) {
                 clearInterval(pollingInterval);
                 pollingInterval = null;
             }

            domElements.statusDisplay.classList.remove('hidden');
            domElements.jobIdSpan.textContent = jobId; // Show ID immediately
            domElements.statusSpan.textContent = "Checking..."; // Initial state


            const updateStatus = async () => {
                console.log(`Polling status for ${jobId}...`);
                try {
                    const response = await fetch(`${API_BASE_URL}/status/${jobId}`);

                    // Handle 404 specifically
                    if (response.status === 404) {
                         console.log(`Job ${jobId} not found (404).`);
                         domElements.statusSpan.textContent = 'Not Found';
                         domElements.messageSpan.textContent = 'Job ID not found.';
                         domElements.progressValueSpan.textContent = '0%';
                         domElements.progressBar.style.width = '0%';
                         domElements.downloadSection.classList.add('hidden');
                         domElements.videoPreview.classList.add('hidden');
                         clearInterval(pollingInterval);
                         pollingInterval = null;
                         localStorage.removeItem('lastJobId'); // Remove invalid ID
                         return; // Stop polling
                    }

                    if (!response.ok) {
                         // Handle other errors
                         throw new Error(`Status check failed: ${response.statusText} (${response.status})`);
                    }

                    const data = await response.json();

                    // Update UI elements
                    domElements.jobIdSpan.textContent = data.job_id;
                    domElements.statusSpan.textContent = data.status;
                    domElements.progressValueSpan.textContent = `${data.progress || 0}%`;
                    domElements.progressBar.style.width = `${data.progress || 0}%`;
                    domElements.messageSpan.textContent = data.message || 'No message';

                    // Handle terminal states (completed/failed)
                    const isTerminal = data.status === 'completed' || data.status === 'failed';

                    if (data.status === 'completed' && data.video_url) {
                        const videoUrl = `${API_BASE_URL}${data.video_url}`;
                        domElements.downloadLink.href = videoUrl;
                        domElements.videoSource.src = videoUrl; // Set source for preview
                        domElements.downloadSection.classList.remove('hidden');
                        // Don't show preview immediately, wait for button click
                        domElements.videoPreview.classList.add('hidden');
                    } else {
                        domElements.downloadSection.classList.add('hidden');
                        domElements.videoPreview.classList.add('hidden');
                    }

                    if (isTerminal) {
                        console.log(`Job ${jobId} reached terminal state: ${data.status}`);
                         clearInterval(pollingInterval);
                         pollingInterval = null;
                         localStorage.removeItem('lastJobId'); // Clear ID once finished
                    }

                } catch (error) {
                    console.error(`Error checking status for job ${jobId}:`, error);
                    // Avoid flooding logs if server is down temporarily
                    // Show error in UI but don't necessarily stop polling immediately unless it's a 404
                     domElements.statusSpan.textContent = 'Error';
                     domElements.messageSpan.textContent = `Error fetching status: ${error.message}`;
                    // Maybe add logic here to stop polling after several consecutive errors
                }
            };

            // Initial immediate check
            await updateStatus();

            // Start polling only if not already in a terminal state
            if (!pollingInterval && !['completed', 'failed', 'Not Found', 'Error'].includes(domElements.statusSpan.textContent)) {
                pollingInterval = setInterval(updateStatus, POLLING_INTERVAL_MS);
                 console.log(`Started polling for ${jobId}`);
            } else {
                 console.log(`Not starting polling for ${jobId}, initial state is terminal or error.`);
            }
        }

        // Manual status check button
        domElements.checkStatusBtn.addEventListener('click', () => {
            const jobId = domElements.jobIdInput.value;
             if (jobId) {
                localStorage.setItem('lastJobId', jobId); // Save potentially new manual ID
                checkJobStatus(jobId);
            } else {
                resetStatusDisplay();
                showFormMessage("Please enter a Job ID to check.", true);
            }
        });

         // Preview button logic
         domElements.previewBtn.addEventListener('click', () => {
             if (domElements.videoSource.src && domElements.videoSource.src !== window.location.href) { // Check if src is valid
                 domElements.videoPreview.classList.toggle('hidden');
                 if (!domElements.videoPreview.classList.contains('hidden')) {
                     domElements.videoPreview.load(); // Ensure it loads the source
                     // domElements.videoPreview.play(); // Optional: auto-play
                 } else {
                      domElements.videoPreview.pause(); // Pause if hiding
                 }
             }
         });

    </script>
</body>
</html>
